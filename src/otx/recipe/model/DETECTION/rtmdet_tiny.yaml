engine:
  task: DETECTION
  device: auto

model:
  class_path: otx.core.model.module.detection.OTXDetectionLitModule
  init_args:
    torch_compile: false
    otx_model:
      class_path: otx.core.model.entity.detection.MMDetCompatibleModel
      init_args:
        config:
          backbone:
            act_cfg:
              inplace: true
              type: SiLU
            arch: P5
            channel_attention: true
            deepen_factor: 0.167
            expand_ratio: 0.5
            init_cfg:
              checkpoint: https://download.openmmlab.com/mmdetection/v3.0/rtmdet/cspnext_rsb_pretrain/cspnext-tiny_imagenet_600e.pth
              prefix: backbone.
              type: Pretrained
            norm_cfg:
              type: SyncBN
            type: CSPNeXt
            widen_factor: 0.375
          bbox_head:
            act_cfg:
              inplace: true
              type: SiLU
            anchor_generator:
              offset: 0
              strides:
                - 8
                - 16
                - 32
              type: MlvlPointGenerator
            bbox_coder:
              type: DistancePointBBoxCoder
            exp_on_reg: false
            feat_channels: 96
            in_channels: 96
            loss_bbox:
              loss_weight: 2.0
              type: GIoULoss
            loss_cls:
              beta: 2.0
              loss_weight: 1.0
              type: QualityFocalLoss
              use_sigmoid: true
            norm_cfg:
              type: SyncBN
            num_classes: 80
            pred_kernel_size: 1
            share_conv: true
            stacked_convs: 2
            type: RTMDetSepBNHead
            with_objectness: false
          data_preprocessor:
            batch_augments: null
            bgr_to_rgb: false
            mean:
              - 103.53
              - 116.28
              - 123.675
            std:
              - 57.375
              - 57.12
              - 58.395
            type: DetDataPreprocessor
          neck:
            act_cfg:
              inplace: true
              type: SiLU
            expand_ratio: 0.5
            in_channels:
              - 96
              - 192
              - 384
            norm_cfg:
              type: SyncBN
            num_csp_blocks: 1
            out_channels: 96
            type: CSPNeXtPAFPN
          test_cfg:
            max_per_img: 300
            min_bbox_size: 0
            nms:
              iou_threshold: 0.65
              type: nms
            nms_pre: 30000
            score_thr: 0.001
          train_cfg:
            allowed_border: -1
            assigner:
              topk: 13
              type: DynamicSoftLabelAssigner
            debug: false
            pos_weight: -1
          type: RTMDet
    optimizer:
      class_path: torch.optim.Adam
      init_args:
        lr: 1e-3
        weight_decay: 0.0
    scheduler:
      class_path: lightning.pytorch.cli.ReduceLROnPlateau
      init_args:
        mode: min
        factor: 0.5
        patience: 1
        monitor: train/loss

data:
  task: DETECTION
  config:
    mem_cache_size: 1GB
    mem_cache_img_max_size: null
    data_format: coco_instances
    train_subset:
      subset_name: train
      batch_size: 32
      num_workers: 2
      transform_lib_type: MMDET
      transforms:
        - backend_args: null
          type: LoadImageFromFile
        - type: LoadAnnotations
          with_bbox: true
        - img_scale:
            - 640
            - 640
          max_cached_images: 20
          pad_val: 114.0
          random_pop: false
          type: CachedMosaic
        - keep_ratio: true
          ratio_range:
            - 0.5
            - 2.0
          scale:
            - 1280
            - 1280
          type: RandomResize
        - crop_size:
            - 640
            - 640
          type: RandomCrop
        - type: YOLOXHSVRandomAug
        - prob: 0.5
          type: RandomFlip
        - pad_val:
            img:
              - 114
              - 114
              - 114
          size:
            - 640
            - 640
          type: Pad
        - img_scale:
            - 640
            - 640
          max_cached_images: 10
          pad_val:
            - 114
            - 114
            - 114
          prob: 0.5
          random_pop: false
          ratio_range:
            - 1.0
            - 1.0
          type: CachedMixUp
        - type: PackDetInputs
    val_subset:
      subset_name: val
      num_workers: 2
      batch_size: 5
      transform_lib_type: MMDET
      transforms:
        - backend_args: null
          type: LoadImageFromFile
        - keep_ratio: true
          scale:
            - 640
            - 640
          type: Resize
        - pad_val:
            img:
              - 114
              - 114
              - 114
          size:
            - 640
            - 640
          type: Pad
        - type: LoadAnnotations
          with_bbox: true
        - meta_keys:
            - img_id
            - img_path
            - ori_shape
            - img_shape
            - scale_factor
          type: PackDetInputs
    test_subset:
      subset_name: test
      num_workers: 2
      batch_size: 5
      transform_lib_type: MMDET
      transforms:
        - backend_args: null
          type: LoadImageFromFile
        - keep_ratio: true
          scale:
            - 640
            - 640
          type: Resize
        - pad_val:
            img:
              - 114
              - 114
              - 114
          size:
            - 640
            - 640
          type: Pad
        - type: LoadAnnotations
          with_bbox: true
        - meta_keys:
            - img_id
            - img_path
            - ori_shape
            - img_shape
            - scale_factor
          type: PackDetInputs

# engine.train arguments
max_epochs: 10
callbacks:
  - class_path: lightning.pytorch.callbacks.EarlyStopping
    init_args:
      monitor: val/map
      mode: max
      patience: 100
  - class_path: lightning.pytorch.callbacks.RichProgressBar
    init_args:
      refresh_rate: 1
      leave: false
  - class_path: lightning.pytorch.callbacks.ModelCheckpoint
    init_args:
      monitor: val/map
      mode: max
      save_top_k: 1
      save_last: True
      auto_insert_metric_name: False
      filename: "epoch_{epoch:03d}"
  - class_path: otx.algo.callbacks.iteration_timer.IterationTimer
    init_args:
      prog_bar: true
      on_step: True
      on_epoch: True
  - class_path: lightning.pytorch.callbacks.RichModelSummary
    init_args:
      max_depth: 1
  - class_path: lightning.pytorch.callbacks.LearningRateMonitor
logger:
  - class_path: lightning.pytorch.loggers.csv_logs.CSVLogger
    init_args:
      save_dir: ""
      name: "csv/"
      prefix: ""
  - class_path: lightning.pytorch.loggers.tensorboard.TensorBoardLogger
    init_args:
      save_dir: ""
      name: "tensorboard/"
      log_graph: False
      default_hp_metric: True
      prefix: ""
deterministic: false
seed: null
precision: "32"
val_check_interval: 1
