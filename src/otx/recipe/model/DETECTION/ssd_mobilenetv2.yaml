engine:
  task: DETECTION
  device: auto

model:
  class_path: otx.core.model.module.detection.OTXDetectionLitModule
  init_args:
    torch_compile: false
    otx_model:
      class_path: otx.core.model.entity.detection.MMDetCompatibleModel
      init_args:
        config:
          load_from: https://storage.openvinotoolkit.org/repositories/openvino_training_extensions/models/object_detection/v2/mobilenet_v2-2s_ssd-992x736.pth
          train_cfg:
            assigner:
              type: MaxIoUAssigner
              min_pos_iou: 0.0
              ignore_iof_thr: -1
              gt_max_assign_all: false
              pos_iou_thr: 0.4
              neg_iou_thr: 0.4
            smoothl1_beta: 1.0
            allowed_border: -1
            pos_weight: -1
            neg_pos_ratio: 3
            debug: false
            use_giou: false
            use_focal: false
          test_cfg:
            nms:
              type: nms
              iou_threshold: 0.45
            min_bbox_size: 0
            score_thr: 0.02
            max_per_img: 200
          type: SingleStageDetector
          backbone:
            type: mobilenetv2_w1
            out_indices:
              - 4
              - 5
            frozen_stages: -1
            norm_eval: false
            pretrained: true
          data_preprocessor:
            type: DetDataPreprocessor
            mean:
              - 0
              - 0
              - 0
            std:
              - 255
              - 255
              - 255
            bgr_to_rgb: true
            pad_size_divisor: 32
          bbox_head:
            type: CustomSSDHead
            num_classes: 80
            in_channels:
              - 96
              - 320
            use_depthwise: true
            norm_cfg:
              type: BN
            act_cfg:
              type: ReLU
            init_cfg:
              type: Xavier
              layer: Conv2d
              distribution: uniform
            anchor_generator:
              type: SSDAnchorGeneratorClustered
              strides:
                - 16
                - 32
              widths:
                - - 38.641007923271076
                  - 92.49516032784699
                  - 271.4234764938237
                  - 141.53469410876247
                - - 206.04136086566515
                  - 386.6542727907841
                  - 716.9892752215089
                  - 453.75609561761405
                  - 788.4629155558277
              heights:
                - - 48.9243877087132
                  - 147.73088476194903
                  - 158.23569788707474
                  - 324.14510379107367
                - - 587.6216059488938
                  - 381.60024152086544
                  - 323.5988913027747
                  - 702.7486097568518
                  - 741.4865860938451
            bbox_coder:
              type: DeltaXYWHBBoxCoder
              target_means:
                - 0.0
                - 0.0
                - 0.0
                - 0.0
              target_stds:
                - 0.1
                - 0.1
                - 0.2
                - 0.2
    optimizer:
      class_path: torch.optim.SGD
      init_args:
        lr: 0.01
        weight_decay: 0.001
        momentum: 0.9
    scheduler:
      class_path: lightning.pytorch.cli.ReduceLROnPlateau
      init_args:
        mode: min
        factor: 0.5
        patience: 1
        monitor: train/loss

data:
  task: DETECTION
  config:
    mem_cache_size: 1GB
    mem_cache_img_max_size: null
    data_format: coco_instances
    train_subset:
      subset_name: train
      batch_size: 8
      num_workers: 2
      transform_lib_type: MMDET
      transforms:
        - type: LoadImageFromFile
        - type: LoadAnnotations
          with_bbox: true
        - type: PhotoMetricDistortion
          brightness_delta: 32
          contrast_range:
            - 0.5
            - 1.5
          hue_delta: 18
        - type: MinIoURandomCrop
          min_ious:
            - 0.1
            - 0.3
            - 0.5
            - 0.7
            - 0.9
          min_crop_size: 0.3
        - type: Resize
          scale:
            - 864
            - 864
          keep_ratio: false
        - type: RandomFlip
          prob: 0.5
        - type: PackDetInputs
          meta_keys:
            - ori_filename
            - flip_direction
            - scale_factor
            - gt_ann_ids
            - flip
            - ignored_labels
            - ori_shape
            - filename
            - img_shape
            - pad_shape
    val_subset:
      subset_name: val
      num_workers: 2
      batch_size: 1
      transform_lib_type: MMDET
      transforms:
        - type: LoadImageFromFile
        - type: Resize
          scale:
            - 864
            - 864
          keep_ratio: false
        - type: LoadAnnotations
          with_bbox: true
        - type: PackDetInputs
          meta_keys:
            - ori_filename
            - scale_factor
            - ori_shape
            - filename
            - img_shape
            - pad_shape
    test_subset:
      subset_name: test
      num_workers: 2
      batch_size: 1
      transform_lib_type: MMDET
      transforms:
        - type: LoadImageFromFile
        - type: Resize
          scale:
            - 864
            - 864
          keep_ratio: false
        - type: LoadAnnotations
          with_bbox: true
        - type: PackDetInputs
          meta_keys:
            - ori_filename
            - scale_factor
            - ori_shape
            - filename
            - img_shape
            - pad_shape

# engine.train arguments
max_epochs: 10
callbacks:
  - class_path: lightning.pytorch.callbacks.EarlyStopping
    init_args:
      monitor: val/map
      mode: max
      patience: 100
  - class_path: lightning.pytorch.callbacks.RichProgressBar
    init_args:
      refresh_rate: 1
      leave: false
  - class_path: lightning.pytorch.callbacks.ModelCheckpoint
    init_args:
      monitor: val/map
      mode: max
      save_top_k: 1
      save_last: True
      auto_insert_metric_name: False
      filename: "epoch_{epoch:03d}"
  - class_path: otx.algo.callbacks.iteration_timer.IterationTimer
    init_args:
      prog_bar: true
      on_step: True
      on_epoch: True
  - class_path: lightning.pytorch.callbacks.RichModelSummary
    init_args:
      max_depth: 1
  - class_path: lightning.pytorch.callbacks.LearningRateMonitor
logger:
  - class_path: lightning.pytorch.loggers.csv_logs.CSVLogger
    init_args:
      save_dir: ""
      name: "csv/"
      prefix: ""
  - class_path: lightning.pytorch.loggers.tensorboard.TensorBoardLogger
    init_args:
      save_dir: ""
      name: "tensorboard/"
      log_graph: False
      default_hp_metric: True
      prefix: ""
deterministic: false
seed: null
precision: "32"
val_check_interval: 1
