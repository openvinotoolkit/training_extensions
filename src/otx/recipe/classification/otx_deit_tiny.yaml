engine:
  task: MULTI_CLASS_CLS
  device: auto

model:
  class_path: otx.core.model.module.classification.OTXClassificationLitModule
  init_args:
    torch_compile: false
    otx_model:
      class_path: otx.core.model.entity.classification.MMPretrainCompatibleModel
      init_args:
        config:
          load_from: https://download.openmmlab.com/mmclassification/v0/deit/deit-tiny_pt-4xb256_in1k_20220218-13b382a0.pth
          backbone:
            arch: deit-tiny
            type: VisionTransformer
            img_size: 224
            patch_size: 16
          head:
            loss:
              loss_weight: 1.0
              type: CrossEntropyLoss
            in_channels: 192
            num_classes: 1000
            type: VisionTransformerClsHead
          data_preprocessor:
            mean:
              - 123.675
              - 116.28
              - 103.53
            std:
              - 58.395
              - 57.12
              - 57.375
            to_rgb: True
            type: ClsDataPreprocessor
          init_cfg:
            - std: 0.2
              layer: Linear
              type: TruncNormal
            - bias: 0.
              val: 1.
              layer: LayerNorm
              type: Constant
          type: ImageClassifier
    optimizer:
      class_path: torch.optim.SGD
      init_args:
        lr: 0.0001
        momentum: 0.9
        weight_decay: 0.0001
    scheduler:
      class_path: lightning.pytorch.cli.ReduceLROnPlateau
      init_args:
        factor: 0.5
        patience: 1
        monitor: train/loss

data:
  task: MULTI_CLASS_CLS
  config:
    data_format: imagenet_with_subset_dirs
    mem_cache_img_max_size:
      - 500
      - 500
    mem_cache_size: 1GB
    train_subset:
      subset_name: train
      num_workers: 2
      batch_size: 64
      transform_lib_type: MMPRETRAIN
      transforms:
        - type: LoadImageFromFile
        - backend: cv2
          scale: 224
          type: RandomResizedCrop
        - type: PackInputs
    val_subset:
      subset_name: val
      num_workers: 2
      batch_size: 64
      transform_lib_type: MMPRETRAIN
      transforms:
        - type: LoadImageFromFile
        - backend: cv2
          edge: short
          scale: 256
          type: ResizeEdge
        - crop_size: 224
          type: CenterCrop
        - type: PackInputs
    test_subset:
      subset_name: test
      num_workers: 2
      batch_size: 64
      transform_lib_type: MMPRETRAIN
      transforms:
        - type: LoadImageFromFile
        - backend: cv2
          edge: short
          scale: 256
          type: ResizeEdge
        - crop_size: 224
          type: CenterCrop
        - type: PackInputs

# engine.train arguments
max_epochs: 10
callbacks:
  - class_path: lightning.pytorch.callbacks.EarlyStopping
    init_args:
      monitor: val/accuracy
      mode: max
      patience: 100
  - class_path: lightning.pytorch.callbacks.RichProgressBar
    init_args:
      refresh_rate: 1
      leave: false
  - class_path: lightning.pytorch.callbacks.ModelCheckpoint
    init_args:
      monitor: val/accuracy
      mode: max
      save_top_k: 1
      save_last: True
      auto_insert_metric_name: False
      filename: "epoch_{epoch:03d}"
  - class_path: otx.algo.callbacks.iteration_timer.IterationTimer
    init_args:
      prog_bar: true
      on_step: True
      on_epoch: True
  - class_path: lightning.pytorch.callbacks.RichModelSummary
    init_args:
      max_depth: 1
  - class_path: lightning.pytorch.callbacks.LearningRateMonitor
logger:
  - class_path: lightning.pytorch.loggers.csv_logs.CSVLogger
    init_args:
      save_dir: ""
      name: "csv/"
      prefix: ""
  - class_path: lightning.pytorch.loggers.tensorboard.TensorBoardLogger
    init_args:
      save_dir: ""
      name: "tensorboard/"
      log_graph: False
      default_hp_metric: True
      prefix: ""
deterministic: false
seed: null
precision: "32"
val_check_interval: 1
