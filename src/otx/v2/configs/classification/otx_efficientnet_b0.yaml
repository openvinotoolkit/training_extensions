# Basic Information for Config
framework: mmcls
task: Classification
train_type: Incremental

# Model Configuration
model:
  type: SAMImageClassifier
  backbone:
    pretrained: true
    type: otx.OTXEfficientNet
    version: b0
  head:
    in_channels: -1
    loss:
      loss_weight: 1.0
      type: CrossEntropyLoss
    num_classes: 1000
    topk: !!python/tuple
      - 1
      - 5
    type: CustomLinearClsHead
  neck:
    type: GlobalAveragePooling
  pretrained: null

# Data Configuration
data:
  samples_per_gpu: 32
  test:
    pipeline:
      - size: 224
        type: Resize
      - mean:
          - 123.675
          - 116.28
          - 103.53
        std:
          - 58.395
          - 57.12
          - 57.375
        to_rgb: true
        type: Normalize
      - keys:
          - img
        type: ImageToTensor
      - keys:
          - img
        type: Collect
    test_mode: true
    type: OTXClsDataset
  train:
    pipeline:
      - size: 224
        type: Resize
      - direction: horizontal
        flip_prob: 0.5
        type: RandomFlip
      - config_str: augmix-m5-w3-d1
        type: AugMixAugment
      - angle: !!python/tuple
          - -10
          - 10
        p: 0.35
        type: RandomRotate
      - keys:
          - img
        type: PILImageToNDArray
      - mean:
          - 123.675
          - 116.28
          - 103.53
        std:
          - 58.395
          - 57.12
          - 57.375
        to_rgb: true
        type: Normalize
      - keys:
          - img
        type: ImageToTensor
      - keys:
          - gt_label
        type: ToTensor
      - keys:
          - img
          - gt_label
        type: Collect
    type: OTXClsDataset
  val:
    pipeline:
      - size: 224
        type: Resize
      - mean:
          - 123.675
          - 116.28
          - 103.53
        std:
          - 58.395
          - 57.12
          - 57.375
        to_rgb: true
        type: Normalize
      - keys:
          - img
        type: ImageToTensor
      - keys:
          - img
        type: Collect
    test_mode: true
    type: OTXClsDataset
  workers_per_gpu: 2

#### Other Configuration for Task
log_level: INFO
log_config:
  hooks:
    - ignore_last: false
      type: TextLoggerHook
    - type: TensorboardLoggerHook
  interval: 100
checkpoint_config:
  interval: 1
  max_keep_ckpts: 1
  type: CheckpointHookWithValResults
lr_config:
  min_lr_ratio: 0.0001
  policy: CosineAnnealing

cudnn_benchmark: true
dist_params:
  backend: nccl
  linear_scale_lr: true

deterministic: false

evaluation:
  metric:
    - accuracy
    - class_accuracy

fp16:
  loss_scale: 512.0
hparams:
  dummy: 0
load_from: null

optimizer:
  lr: 0.01
  momentum: 0.9
  type: SGD
  weight_decay: 0.0005
optimizer_config:
  grad_clip: null
  type: SAMOptimizerHook

resume_from: null
runner:
  max_epochs: 20
  type: EpochRunnerWithCancel
seed: 5
task_adapt:
  op: REPLACE
  type: mpa
workflow:
  - !!python/tuple
    - train
    - 1
