# Basic Information for Config
framework: mmaction
data:
  task: Action Classification
  train_type: Incremental

model:
  type: Recognizer3D
  name: otx_x3d
  backbone:
    type: X3D
    gamma_w: 1
    gamma_b: 2.25
    gamma_d: 2.2
  cls_head:
    type: X3DHead
    in_channels: 432
    num_classes: 400
    spatial_type: avg
    dropout_ratio: 0.5
    fc1_bias: false
    average_clips: prob
  data_preprocessor:
    type: ActionDataPreprocessor
    mean:
      - 0.0
      - 0.0
      - 0.0
    std:
      - 255.0
      - 255.0
      - 255.0
    to_rgb: False
    format_shape: NCTHW

train_dataloader:
  batch_size: 10
  num_workers: 0
  dataset:
    type: OTXActionClsDataset
    pipeline:
      - type: SampleFrames
        clip_len: 8
        frame_interval: 4
        num_clips: 1
      - type: OTXRawFrameDecode
      - type: Resize
        scale: !!python/tuple
          - -1
          - 256
      - type: Flip
        flip_ratio: 0.5
      - type: FormatShape
        input_format: NCTHW
      - type: PackActionInputs

val_dataloader:
  batch_size: 1
  num_workers: 0
  dataset:
    type: OTXActionClsDataset
    pipeline:
      - type: SampleFrames
        clip_len: 8
        frame_interval: 4
        num_clips: 1
        test_mode: True
      - type: OTXRawFrameDecode
      - type: Resize
        scale: !!python/tuple
          - -1
          - 256
      - type: CenterCrop
        crop_size: 224
      - type: FormatShape
        input_format: NCTHW
      - type: PackActionInputs

test_dataloader:
  batch_size: 1
  num_workers: 0
  dataset:
    type: OTXActionClsDataset
    pipeline:
      - type: SampleFrames
        clip_len: 8
        frame_interval: 4
        num_clips: 1
        test_mode: True
      - type: OTXRawFrameDecode
      - type: Resize
        scale: !!python/tuple
          - -1
          - 256
      - type: CenterCrop
        crop_size: 224
      - type: FormatShape
        input_format: NCTHW
      - type: PackActionInputs

# Hooks
default_hooks:
  logger:
    type: LoggerHook
    interval: 10
  timer:
    type: IterTimerHook
  checkpoint:
    type: CheckpointHook
    interval: 1
    max_keep_ckpts: 1
    save_best: auto

param_scheduler:
  - type: LinearLR
    by_epoch: true
    begin: 0
    end: 3
  - type: CosineAnnealingLR

# Visualizer
visualizer:
  type: ActionVisualizer
  vis_backends:
    - type: LocalVisBackend
    - type: TensorboardVisBackend

# Evaluation
val_evaluator:
  type: AccMetric
  metric_list: !!python/tuple
    - top_k_accuracy
    - mean_class_accuracy

test_evaluator:
  type: AccMetric
  metric_list: !!python/tuple
    - top_k_accuracy
    - mean_class_accuracy

# Optimizer
optim_wrapper:
  optimizer:
    type: AdamW
    lr: 0.001
    weight_decay: 0.0001
  clip_grad:
    max_norm: 40.0
    norm_type: 2

# OTX Training Configs
max_epochs: 10
max_iters: null
val_interval: 1
seed: 2
deterministic: false
precision: float32
