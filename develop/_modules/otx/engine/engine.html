<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>otx.engine.engine &#8212; OpenVINOâ„¢ Training Extensions 2.2.0rc0 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=796348d33e8b1d947c94" rel="stylesheet">
<link href="../../../_static/styles/bootstrap.css?digest=796348d33e8b1d947c94" rel="stylesheet">
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=796348d33e8b1d947c94" rel="stylesheet">

  
  <link href="../../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=796348d33e8b1d947c94" rel="stylesheet">
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2">
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2">
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/tabs.css?v=a5c4661c" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-design.min.css?v=87e54e7c" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/custom.css?v=0a108b04" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=796348d33e8b1d947c94">
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=796348d33e8b1d947c94">

    <script src="../../../_static/documentation_options.js?v=6e6ef3c1"></script>
    <script src="../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../../_static/tabs.js?v=3030b3cb"></script>
    <script src="../../../_static/design-tabs.js?v=f930bc37"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/otx/engine/engine';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="docsearch:language" content="en">
  </head>
  
  
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="180" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>

  
  <input type="checkbox" class="sidebar-toggle" name="__primary" id="__primary">
  <label class="overlay overlay-primary" for="__primary"></label>

  
  <input type="checkbox" class="sidebar-toggle" name="__secondary" id="__secondary">
  <label class="overlay overlay-secondary" for="__secondary"></label>

  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
      
<form class="bd-search d-flex align-items-center" action="../../../search.html" method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search" aria-label="Search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
    </div>
  </div>

  
  <nav class="bd-header navbar navbar-expand-lg bd-navbar" id="navbar-main"><div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
      <span class="fa-solid fa-bars"></span>
  </label>
  <div id="navbar-start">
    
    
  


<a class="navbar-brand logo" href="../../../index.html">

  
  
  
  
  
  
  

  
    <img src="../../../_static/logos/otx-logo.png" class="logo__image only-light" alt="Logo image">
    <img src="../../../_static/logos/otx-logo.png" class="logo__image only-dark" alt="Logo image">
  
  
</a>
    
  </div>

  
  <div class="col-lg-9 navbar-header-items">
    <div id="navbar-center" class="mr-auto">
      
    </div>

    <div id="navbar-end">
      
        <div class="navbar-end-item navbar-persistent--container">
          
<button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-toggle="tooltip">
  <i class="fa-solid fa-magnifying-glass"></i>
</button>
        </div>
      
      
      <div class="navbar-end-item">
        
<form class="bd-search d-flex align-items-center" action="../../../search.html" method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search" aria-label="Search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
      </div>
      
      <div class="navbar-end-item">
        <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
</button>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          <a href="https://github.com/openvinotoolkit/training_extensions" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-toggle="tooltip"><img src="../../../_static/logos/github_icon.png" class="icon-link-image" alt="GitHub"/></a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>


  
  
    <div class="navbar-persistent--mobile">
<button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-toggle="tooltip">
  <i class="fa-solid fa-magnifying-glass"></i>
</button>
    </div>
  

  
  <label class="sidebar-toggle secondary-toggle" for="__secondary">
      <span class="fa-solid fa-outdent"></span>
  </label>
  

</div>
  </nav>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar hide-on-wide">
        
  
  <div class="sidebar-header-items sidebar-primary__section">
    
    

    
    
    <div class="sidebar-header-items__end">
      
      <div class="navbar-end-item">
        
<form class="bd-search d-flex align-items-center" action="../../../search.html" method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search" aria-label="Search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
      </div>
      
      <div class="navbar-end-item">
        <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
</button>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          <a href="https://github.com/openvinotoolkit/training_extensions" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-toggle="tooltip"><img src="../../../_static/logos/github_icon.png" class="icon-link-image" alt="GitHub"/></a>
        </li>
      </ul>
      </div>
      
    </div>
    
  </div>

  

  
  <div class="sidebar-end-items sidebar-primary__section">
    <div class="sidebar-end-items__item">
    </div>
  </div>

  
  <div id="rtd-footer-container"></div>

      </div>
      <main id="main-content" class="bd-main">
        
        
        <div class="bd-content">
          <div class="bd-article-container">
            
            <div class="bd-header-article">
                
            </div>
            
            
            <article class="bd-article" role="main">
              
  <h1>Source code for otx.engine.engine</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright (C) 2024 Intel Corporation</span>
<span class="c1"># SPDX-License-Identifier: Apache-2.0</span>
<span class="c1">#</span>
<span class="sd">&quot;&quot;&quot;Module for OTX engine components.&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">ClassVar</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Iterator</span><span class="p">,</span> <span class="n">Literal</span>
<span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">warn</span>

<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">lightning</span> <span class="kn">import</span> <span class="n">Trainer</span><span class="p">,</span> <span class="n">seed_everything</span>

<span class="kn">from</span> <span class="nn">otx.algo.plugins</span> <span class="kn">import</span> <span class="n">MixedPrecisionXPUPlugin</span>
<span class="kn">from</span> <span class="nn">otx.core.config.device</span> <span class="kn">import</span> <span class="n">DeviceConfig</span>
<span class="kn">from</span> <span class="nn">otx.core.config.explain</span> <span class="kn">import</span> <span class="n">ExplainConfig</span>
<span class="kn">from</span> <span class="nn">otx.core.config.hpo</span> <span class="kn">import</span> <span class="n">HpoConfig</span>
<span class="kn">from</span> <span class="nn">otx.core.data.module</span> <span class="kn">import</span> <span class="n">OTXDataModule</span>
<span class="kn">from</span> <span class="nn">otx.core.model.base</span> <span class="kn">import</span> <span class="n">OTXModel</span><span class="p">,</span> <span class="n">OVModel</span>
<span class="kn">from</span> <span class="nn">otx.core.types</span> <span class="kn">import</span> <span class="n">PathLike</span>
<span class="kn">from</span> <span class="nn">otx.core.types.device</span> <span class="kn">import</span> <span class="n">DeviceType</span>
<span class="kn">from</span> <span class="nn">otx.core.types.export</span> <span class="kn">import</span> <span class="n">OTXExportFormatType</span>
<span class="kn">from</span> <span class="nn">otx.core.types.precision</span> <span class="kn">import</span> <span class="n">OTXPrecisionType</span>
<span class="kn">from</span> <span class="nn">otx.core.types.task</span> <span class="kn">import</span> <span class="n">OTXTaskType</span>
<span class="kn">from</span> <span class="nn">otx.core.utils.cache</span> <span class="kn">import</span> <span class="n">TrainerArgumentsCache</span>
<span class="kn">from</span> <span class="nn">otx.utils.utils</span> <span class="kn">import</span> <span class="n">is_xpu_available</span><span class="p">,</span> <span class="n">measure_flops</span>

<span class="kn">from</span> <span class="nn">.adaptive_bs</span> <span class="kn">import</span> <span class="n">adapt_batch_size</span>
<span class="kn">from</span> <span class="nn">.hpo</span> <span class="kn">import</span> <span class="n">execute_hpo</span><span class="p">,</span> <span class="n">update_hyper_parameter</span>
<span class="kn">from</span> <span class="nn">.utils.auto_configurator</span> <span class="kn">import</span> <span class="n">DEFAULT_CONFIG_PER_TASK</span><span class="p">,</span> <span class="n">AutoConfigurator</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">lightning</span> <span class="kn">import</span> <span class="n">Callback</span>
    <span class="kn">from</span> <span class="nn">lightning.pytorch.loggers</span> <span class="kn">import</span> <span class="n">Logger</span>
    <span class="kn">from</span> <span class="nn">lightning.pytorch.utilities.types</span> <span class="kn">import</span> <span class="n">EVAL_DATALOADERS</span><span class="p">,</span> <span class="n">TRAIN_DATALOADERS</span>
    <span class="kn">from</span> <span class="nn">pytorch_lightning.trainer.connectors.accelerator_connector</span> <span class="kn">import</span> <span class="n">_PRECISION_INPUT</span>

    <span class="kn">from</span> <span class="nn">otx.core.metrics</span> <span class="kn">import</span> <span class="n">MetricCallable</span>


<span class="n">LITMODULE_PER_TASK</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">OTXTaskType</span><span class="o">.</span><span class="n">MULTI_CLASS_CLS</span><span class="p">:</span> <span class="s2">&quot;otx.core.model.module.classification.OTXMulticlassClsLitModule&quot;</span><span class="p">,</span>
    <span class="n">OTXTaskType</span><span class="o">.</span><span class="n">MULTI_LABEL_CLS</span><span class="p">:</span> <span class="s2">&quot;otx.core.model.module.classification.OTXMultilabelClsLitModule&quot;</span><span class="p">,</span>
    <span class="n">OTXTaskType</span><span class="o">.</span><span class="n">H_LABEL_CLS</span><span class="p">:</span> <span class="s2">&quot;otx.core.model.module.classification.OTXHlabelClsLitModule&quot;</span><span class="p">,</span>
    <span class="n">OTXTaskType</span><span class="o">.</span><span class="n">DETECTION</span><span class="p">:</span> <span class="s2">&quot;otx.core.model.module.detection.OTXDetectionLitModule&quot;</span><span class="p">,</span>
    <span class="n">OTXTaskType</span><span class="o">.</span><span class="n">ROTATED_DETECTION</span><span class="p">:</span> <span class="s2">&quot;otx.core.model.module.rotated_detection.OTXRotatedDetLitModule&quot;</span><span class="p">,</span>
    <span class="n">OTXTaskType</span><span class="o">.</span><span class="n">INSTANCE_SEGMENTATION</span><span class="p">:</span> <span class="s2">&quot;otx.core.model.module.instance_segmentation.OTXInstanceSegLitModule&quot;</span><span class="p">,</span>
    <span class="n">OTXTaskType</span><span class="o">.</span><span class="n">SEMANTIC_SEGMENTATION</span><span class="p">:</span> <span class="s2">&quot;otx.core.model.module.segmentation.OTXSegmentationLitModule&quot;</span><span class="p">,</span>
    <span class="n">OTXTaskType</span><span class="o">.</span><span class="n">ACTION_CLASSIFICATION</span><span class="p">:</span> <span class="s2">&quot;otx.core.model.module.action_classification.OTXActionClsLitModule&quot;</span><span class="p">,</span>
    <span class="n">OTXTaskType</span><span class="o">.</span><span class="n">VISUAL_PROMPTING</span><span class="p">:</span> <span class="s2">&quot;otx.core.model.module.visual_prompting.OTXVisualPromptingLitModule&quot;</span><span class="p">,</span>
    <span class="n">OTXTaskType</span><span class="o">.</span><span class="n">ZERO_SHOT_VISUAL_PROMPTING</span><span class="p">:</span> <span class="s2">&quot;otx.core.model.module.visual_prompting.OTXZeroShotVisualPromptingLitModule&quot;</span><span class="p">,</span>  <span class="c1"># noqa: E501</span>
<span class="p">}</span>


<span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">override_metric_callable</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">OTXModel</span><span class="p">,</span> <span class="n">new_metric_callable</span><span class="p">:</span> <span class="n">MetricCallable</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">OTXModel</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Override `OTXModel.metric_callable` to change the evaluation metric.</span>

<span class="sd">    Args:</span>
<span class="sd">        model: Model to override its metric callable</span>
<span class="sd">        new_metric_callable: If not None, override the model&#39;s one with this. Otherwise, do not override.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">new_metric_callable</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">model</span>
        <span class="k">return</span>

    <span class="n">orig_metric_callable</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">metric_callable</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">model</span><span class="o">.</span><span class="n">metric_callable</span> <span class="o">=</span> <span class="n">new_metric_callable</span>
        <span class="k">yield</span> <span class="n">model</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">model</span><span class="o">.</span><span class="n">metric_callable</span> <span class="o">=</span> <span class="n">orig_metric_callable</span>


<div class="viewcode-block" id="Engine">
<a class="viewcode-back" href="../../../guide/reference/_autosummary/otx.engine.html#otx.engine.Engine">[docs]</a>
<span class="k">class</span> <span class="nc">Engine</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;OTX Engine.</span>

<span class="sd">    This class defines the Engine for OTX, which governs each step of the OTX workflow.</span>

<span class="sd">    Example:</span>
<span class="sd">        The following examples show how to use the Engine class.</span>

<span class="sd">        Auto-Configuration with data_root::</span>

<span class="sd">            engine = Engine(</span>
<span class="sd">                data_root=&lt;dataset/path&gt;,</span>
<span class="sd">            )</span>

<span class="sd">        Create Engine with Custom OTXModel::</span>

<span class="sd">            engine = Engine(</span>
<span class="sd">                data_root=&lt;dataset/path&gt;,</span>
<span class="sd">                model=OTXModel(...),</span>
<span class="sd">                checkpoint=&lt;checkpoint/path&gt;,</span>
<span class="sd">            )</span>

<span class="sd">        Create Engine with Custom OTXDataModule::</span>

<span class="sd">            engine = Engine(</span>
<span class="sd">                model = OTXModel(...),</span>
<span class="sd">                datamodule = OTXDataModule(...),</span>
<span class="sd">            )</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_EXPORTED_MODEL_BASE_NAME</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;exported_model&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">data_root</span><span class="p">:</span> <span class="n">PathLike</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">task</span><span class="p">:</span> <span class="n">OTXTaskType</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">work_dir</span><span class="p">:</span> <span class="n">PathLike</span> <span class="o">=</span> <span class="s2">&quot;./otx-workspace&quot;</span><span class="p">,</span>
        <span class="n">datamodule</span><span class="p">:</span> <span class="n">OTXDataModule</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">OTXModel</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">checkpoint</span><span class="p">:</span> <span class="n">PathLike</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">DeviceType</span> <span class="o">=</span> <span class="n">DeviceType</span><span class="o">.</span><span class="n">auto</span><span class="p">,</span>
        <span class="n">num_devices</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes the OTX Engine.</span>

<span class="sd">        Args:</span>
<span class="sd">            data_root (PathLike | None, optional): Root directory for the data. Defaults to None.</span>
<span class="sd">            task (OTXTaskType | None, optional): The type of OTX task. Defaults to None.</span>
<span class="sd">            work_dir (PathLike, optional): Working directory for the engine. Defaults to &quot;./otx-workspace&quot;.</span>
<span class="sd">            datamodule (OTXDataModule | None, optional): The data module for the engine. Defaults to None.</span>
<span class="sd">            model (OTXModel | str | None, optional): The model for the engine. Defaults to None.</span>
<span class="sd">            checkpoint (PathLike | None, optional): Path to the checkpoint file. Defaults to None.</span>
<span class="sd">            device (DeviceType, optional): The device type to use. Defaults to DeviceType.auto.</span>
<span class="sd">            num_devices (int, optional): The number of devices to use. If it is 2 or more, it will behave as multi-gpu.</span>
<span class="sd">            **kwargs: Additional keyword arguments for pl.Trainer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="n">TrainerArgumentsCache</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint</span> <span class="o">=</span> <span class="n">checkpoint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">work_dir</span> <span class="o">=</span> <span class="n">work_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>  <span class="c1"># type: ignore[assignment]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_devices</span> <span class="o">=</span> <span class="n">num_devices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_auto_configurator</span> <span class="o">=</span> <span class="n">AutoConfigurator</span><span class="p">(</span>
            <span class="n">data_root</span><span class="o">=</span><span class="n">data_root</span><span class="p">,</span>
            <span class="n">task</span><span class="o">=</span><span class="n">datamodule</span><span class="o">.</span><span class="n">task</span> <span class="k">if</span> <span class="n">datamodule</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">task</span><span class="p">,</span>
            <span class="n">model_name</span><span class="o">=</span><span class="kc">None</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">OTXModel</span><span class="p">)</span> <span class="k">else</span> <span class="n">model</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_datamodule</span><span class="p">:</span> <span class="n">OTXDataModule</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">datamodule</span> <span class="k">if</span> <span class="n">datamodule</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auto_configurator</span><span class="o">.</span><span class="n">get_datamodule</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span> <span class="o">=</span> <span class="n">task</span> <span class="k">if</span> <span class="n">task</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auto_configurator</span><span class="o">.</span><span class="n">task</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_trainer</span><span class="p">:</span> <span class="n">Trainer</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="p">:</span> <span class="n">OTXModel</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">model</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">OTXModel</span><span class="p">)</span>
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auto_configurator</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span>
                <span class="n">label_info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_datamodule</span><span class="o">.</span><span class="n">label_info</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datamodule</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------------------ #</span>
    <span class="c1"># General OTX Entry Points</span>
    <span class="c1"># ------------------------------------------------------------------------ #</span>

<div class="viewcode-block" id="Engine.train">
<a class="viewcode-back" href="../../../guide/reference/_autosummary/otx.engine.html#otx.engine.Engine.train">[docs]</a>
    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">max_epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">deterministic</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;warn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">precision</span><span class="p">:</span> <span class="n">_PRECISION_INPUT</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="s2">&quot;32&quot;</span><span class="p">,</span>
        <span class="n">val_check_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">callbacks</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Callback</span><span class="p">]</span> <span class="o">|</span> <span class="n">Callback</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">logger</span><span class="p">:</span> <span class="n">Logger</span> <span class="o">|</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Logger</span><span class="p">]</span> <span class="o">|</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">resume</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">metric</span><span class="p">:</span> <span class="n">MetricCallable</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">run_hpo</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">hpo_config</span><span class="p">:</span> <span class="n">HpoConfig</span> <span class="o">=</span> <span class="n">HpoConfig</span><span class="p">(),</span>  <span class="c1"># noqa: B008 https://github.com/omni-us/jsonargparse/issues/423</span>
        <span class="n">checkpoint</span><span class="p">:</span> <span class="n">PathLike</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">adaptive_bs</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="s2">&quot;Safe&quot;</span><span class="p">,</span> <span class="s2">&quot;Full&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Trains the model using the provided LightningModule and OTXDataModule.</span>

<span class="sd">        Args:</span>
<span class="sd">            max_epochs (int | None, optional): The maximum number of epochs. Defaults to None.</span>
<span class="sd">            seed (int | None, optional): The random seed. Defaults to None.</span>
<span class="sd">            deterministic (bool | Literal[&quot;warn&quot;]): Whether to enable deterministic behavior.</span>
<span class="sd">                Also, can be set to `warn` to avoid failures, because some operations don&#39;t</span>
<span class="sd">                support deterministic mode. Defaults to False.</span>
<span class="sd">            precision (_PRECISION_INPUT | None, optional): The precision of the model. Defaults to 32.</span>
<span class="sd">            val_check_interval (int | float | None, optional): The validation check interval. Defaults to None.</span>
<span class="sd">            callbacks (list[Callback] | Callback | None, optional): The callbacks to be used during training.</span>
<span class="sd">            logger (Logger | Iterable[Logger] | bool | None, optional): The logger(s) to be used. Defaults to None.</span>
<span class="sd">            resume (bool, optional): If True, tries to resume training from existing checkpoint.</span>
<span class="sd">            metric (MetricCallable | None): If not None, it will override `OTXModel.metric_callable` with the given</span>
<span class="sd">                metric callable. It will temporarilly change the evaluation metric for the validation and test.</span>
<span class="sd">            run_hpo (bool, optional): If True, optimizer hyper parameters before training a model.</span>
<span class="sd">            hpo_config (HpoConfig | None, optional): Configuration for HPO.</span>
<span class="sd">            checkpoint (PathLike | None, optional): Path to the checkpoint file. Defaults to None.</span>
<span class="sd">            adaptive_bs (Literal[&quot;None&quot;, &quot;Safe&quot;, &quot;Full&quot;]):</span>
<span class="sd">                Change the actual batch size depending on the current GPU status.</span>
<span class="sd">                Safe =&gt; Prevent GPU out of memory. Full =&gt; Find a batch size using most of GPU memory.</span>
<span class="sd">            **kwargs: Additional keyword arguments for pl.Trainer configuration.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict[str, Any]: A dictionary containing the callback metrics from the trainer.</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; engine.train(</span>
<span class="sd">            ...     max_epochs=3,</span>
<span class="sd">            ...     seed=1234,</span>
<span class="sd">            ...     deterministic=False,</span>
<span class="sd">            ...     precision=&quot;32&quot;,</span>
<span class="sd">            ... )</span>

<span class="sd">        CLI Usage:</span>
<span class="sd">            1. Can train with data_root only. then OTX will provide default training configuration.</span>
<span class="sd">                ```shell</span>
<span class="sd">                &gt;&gt;&gt; otx train --data_root &lt;DATASET_PATH, str&gt;</span>
<span class="sd">                ```</span>
<span class="sd">            2. Can pick a model or datamodule as Config file or Class.</span>
<span class="sd">                ```shell</span>
<span class="sd">                &gt;&gt;&gt; otx train \</span>
<span class="sd">                ...     --data_root &lt;DATASET_PATH, str&gt; \</span>
<span class="sd">                ...     --model &lt;CONFIG | CLASS_PATH_OR_NAME, OTXModel&gt; \</span>
<span class="sd">                ...     --data &lt;CONFIG | CLASS_PATH_OR_NAME, OTXDataModule&gt;</span>
<span class="sd">                ```</span>
<span class="sd">            3. Of course, can override the various values with commands.</span>
<span class="sd">                ```shell</span>
<span class="sd">                &gt;&gt;&gt; otx train \</span>
<span class="sd">                ...     --data_root &lt;DATASET_PATH, str&gt; \</span>
<span class="sd">                ...     --max_epochs &lt;EPOCHS, int&gt; \</span>
<span class="sd">                ...     --checkpoint &lt;CKPT_PATH, str&gt;</span>
<span class="sd">                ```</span>
<span class="sd">            4. To train with configuration file, run</span>
<span class="sd">                ```shell</span>
<span class="sd">                &gt;&gt;&gt; otx train --data_root &lt;DATASET_PATH, str&gt; --config &lt;CONFIG_PATH, str&gt;</span>
<span class="sd">                ```</span>
<span class="sd">            5. To reproduce the existing training with work_dir, run</span>
<span class="sd">                ```shell</span>
<span class="sd">                &gt;&gt;&gt; otx train --work_dir &lt;WORK_DIR_PATH, str&gt;</span>
<span class="sd">                ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">checkpoint</span> <span class="k">if</span> <span class="n">checkpoint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint</span>

        <span class="k">if</span> <span class="n">adaptive_bs</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">adapt_batch_size</span><span class="p">(</span><span class="n">engine</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="nb">locals</span><span class="p">(),</span> <span class="n">not_increase</span><span class="o">=</span><span class="p">(</span><span class="n">adaptive_bs</span> <span class="o">!=</span> <span class="s2">&quot;Full&quot;</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">run_hpo</span><span class="p">:</span>
            <span class="n">best_config</span><span class="p">,</span> <span class="n">best_trial_weight</span> <span class="o">=</span> <span class="n">execute_hpo</span><span class="p">(</span><span class="n">engine</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">best_config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">update_hyper_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">best_config</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">best_trial_weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">best_trial_weight</span>
                <span class="n">resume</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">seed_everything</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_build_trainer</span><span class="p">(</span>
            <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span>
            <span class="n">callbacks</span><span class="o">=</span><span class="n">callbacks</span><span class="p">,</span>
            <span class="n">precision</span><span class="o">=</span><span class="n">precision</span><span class="p">,</span>
            <span class="n">max_epochs</span><span class="o">=</span><span class="n">max_epochs</span><span class="p">,</span>
            <span class="n">deterministic</span><span class="o">=</span><span class="n">deterministic</span><span class="p">,</span>
            <span class="n">val_check_interval</span><span class="o">=</span><span class="n">val_check_interval</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">fit_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># NOTE: Model&#39;s label info should be converted datamodule&#39;s label info before ckpt loading</span>
        <span class="c1"># This is due to smart weight loading check label name as well as number of classes.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">label_info</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">datamodule</span><span class="o">.</span><span class="n">label_info</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Model label_info is not equal to the Datamodule label_info. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;It will be overriden: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">label_info</span><span class="si">}</span><span class="s2"> =&gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">datamodule</span><span class="o">.</span><span class="n">label_info</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">label_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">datamodule</span><span class="o">.</span><span class="n">label_info</span>

        <span class="k">if</span> <span class="n">resume</span> <span class="ow">and</span> <span class="n">checkpoint</span><span class="p">:</span>
            <span class="c1"># NOTE: If both `resume` and `checkpoint` are provided,</span>
            <span class="c1"># load the entire model state from the checkpoint using the pl.Trainer&#39;s API.</span>
            <span class="n">fit_kwargs</span><span class="p">[</span><span class="s2">&quot;ckpt_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">checkpoint</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">resume</span> <span class="ow">and</span> <span class="n">checkpoint</span><span class="p">:</span>
            <span class="c1"># NOTE: If `resume` is not enabled but `checkpoint` is provided,</span>
            <span class="c1"># load the model state from the checkpoint incrementally.</span>
            <span class="c1"># This means only the model weights are loaded. If there is a mismatch in label_info,</span>
            <span class="c1"># perform incremental weight loading for the model&#39;s classification layer.</span>
            <span class="n">ckpt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">load_state_dict_incrementally</span><span class="p">(</span><span class="n">ckpt</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">override_metric_callable</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">new_metric_callable</span><span class="o">=</span><span class="n">metric</span><span class="p">)</span> <span class="k">as</span> <span class="n">model</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                <span class="n">datamodule</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">datamodule</span><span class="p">,</span>
                <span class="o">**</span><span class="n">fit_kwargs</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">checkpoint_callback</span><span class="o">.</span><span class="n">best_model_path</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">,</span> <span class="p">(</span><span class="n">Path</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;self.checkpoint should be Path or str at this time.&quot;</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">best_checkpoint_symlink</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">work_dir</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;best_checkpoint.ckpt&quot;</span>
        <span class="k">if</span> <span class="n">best_checkpoint_symlink</span><span class="o">.</span><span class="n">is_symlink</span><span class="p">():</span>
            <span class="n">best_checkpoint_symlink</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
        <span class="n">best_checkpoint_symlink</span><span class="o">.</span><span class="n">symlink_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">callback_metrics</span></div>


<div class="viewcode-block" id="Engine.test">
<a class="viewcode-back" href="../../../guide/reference/_autosummary/otx.engine.html#otx.engine.Engine.test">[docs]</a>
    <span class="k">def</span> <span class="nf">test</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">checkpoint</span><span class="p">:</span> <span class="n">PathLike</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">datamodule</span><span class="p">:</span> <span class="n">EVAL_DATALOADERS</span> <span class="o">|</span> <span class="n">OTXDataModule</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">metric</span><span class="p">:</span> <span class="n">MetricCallable</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Run the testing phase of the engine.</span>

<span class="sd">        Args:</span>
<span class="sd">            checkpoint (PathLike | None, optional): Path to the checkpoint file to load the model from.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            datamodule (EVAL_DATALOADERS | OTXDataModule | None, optional): The data module containing the test data.</span>
<span class="sd">            metric (MetricCallable | None): If not None, it will override `OTXModel.metric_callable` with the given</span>
<span class="sd">                metric callable. It will temporarilly change the evaluation metric for the validation and test.</span>
<span class="sd">            **kwargs: Additional keyword arguments for pl.Trainer configuration.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Dictionary containing the callback metrics from the trainer.</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; engine.test(</span>
<span class="sd">            ...     datamodule=OTXDataModule(),</span>
<span class="sd">            ...     checkpoint=&lt;checkpoint/path&gt;,</span>
<span class="sd">            ... )</span>

<span class="sd">        CLI Usage:</span>
<span class="sd">            1. To eval model by specifying the work_dir where did the training, run</span>
<span class="sd">                ```shell</span>
<span class="sd">                &gt;&gt;&gt; otx test --work_dir &lt;WORK_DIR_PATH, str&gt;</span>
<span class="sd">                ```</span>
<span class="sd">            2. To eval model a specific checkpoint, run</span>
<span class="sd">                ```shell</span>
<span class="sd">                &gt;&gt;&gt; otx test --work_dir &lt;WORK_DIR_PATH, str&gt; --checkpoint &lt;CKPT_PATH, str&gt;</span>
<span class="sd">                ```</span>
<span class="sd">            3. Can pick a model.</span>
<span class="sd">                ```shell</span>
<span class="sd">                &gt;&gt;&gt; otx test \</span>
<span class="sd">                ...     --model &lt;CONFIG | CLASS_PATH_OR_NAME&gt; \</span>
<span class="sd">                ...     --data_root &lt;DATASET_PATH, str&gt; \</span>
<span class="sd">                ...     --checkpoint &lt;CKPT_PATH, str&gt;</span>
<span class="sd">                ```</span>
<span class="sd">            4. To eval with configuration file, run</span>
<span class="sd">                ```shell</span>
<span class="sd">                &gt;&gt;&gt; otx test --config &lt;CONFIG_PATH, str&gt; --checkpoint &lt;CKPT_PATH, str&gt;</span>
<span class="sd">                ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">checkpoint</span> <span class="k">if</span> <span class="n">checkpoint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint</span>
        <span class="n">datamodule</span> <span class="o">=</span> <span class="n">datamodule</span> <span class="k">if</span> <span class="n">datamodule</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">datamodule</span>

        <span class="n">is_ir_ckpt</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">))</span><span class="o">.</span><span class="n">suffix</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;.xml&quot;</span><span class="p">,</span> <span class="s2">&quot;.onnx&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">is_ir_ckpt</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">OVModel</span><span class="p">):</span>
            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auto_configurator</span><span class="o">.</span><span class="n">get_ov_model</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">),</span> <span class="n">label_info</span><span class="o">=</span><span class="n">datamodule</span><span class="o">.</span><span class="n">label_info</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">accelerator</span> <span class="o">!=</span> <span class="s2">&quot;cpu&quot;</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;IR model supports inference only on CPU device. The device is changed automatic.&quot;</span>
                <span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">DeviceType</span><span class="o">.</span><span class="n">cpu</span>  <span class="c1"># type: ignore[assignment]</span>

        <span class="c1"># NOTE: Re-initiate datamodule without tiling as model API supports its own tiling mechanism</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">OVModel</span><span class="p">):</span>
            <span class="n">datamodule</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auto_configurator</span><span class="o">.</span><span class="n">update_ov_subset_pipeline</span><span class="p">(</span><span class="n">datamodule</span><span class="o">=</span><span class="n">datamodule</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>

        <span class="c1"># NOTE, trainer.test takes only lightning based checkpoint.</span>
        <span class="c1"># So, it can&#39;t take the OTX1.x checkpoint.</span>
        <span class="k">if</span> <span class="n">checkpoint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_ir_ckpt</span><span class="p">:</span>
            <span class="n">model_cls</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="vm">__class__</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">model_cls</span><span class="o">.</span><span class="n">load_from_checkpoint</span><span class="p">(</span><span class="n">checkpoint_path</span><span class="o">=</span><span class="n">checkpoint</span><span class="p">,</span> <span class="o">**</span><span class="n">model</span><span class="o">.</span><span class="n">hparams</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">label_info</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">datamodule</span><span class="o">.</span><span class="n">label_info</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;To launch a test pipeline, the label information should be same &quot;</span>
                <span class="s2">&quot;between the training and testing datasets. &quot;</span>
                <span class="s2">&quot;Please check whether you use the same dataset: &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;model.label_info=</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">label_info</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;datamodule.label_info=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">datamodule</span><span class="o">.</span><span class="n">label_info</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_build_trainer</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">override_metric_callable</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">new_metric_callable</span><span class="o">=</span><span class="n">metric</span><span class="p">)</span> <span class="k">as</span> <span class="n">model</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">test</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                <span class="n">dataloaders</span><span class="o">=</span><span class="n">datamodule</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">callback_metrics</span></div>


<div class="viewcode-block" id="Engine.predict">
<a class="viewcode-back" href="../../../guide/reference/_autosummary/otx.engine.html#otx.engine.Engine.predict">[docs]</a>
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">checkpoint</span><span class="p">:</span> <span class="n">PathLike</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">datamodule</span><span class="p">:</span> <span class="n">EVAL_DATALOADERS</span> <span class="o">|</span> <span class="n">OTXDataModule</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">return_predictions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">explain</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">explain_config</span><span class="p">:</span> <span class="n">ExplainConfig</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Run predictions using the specified model and data.</span>

<span class="sd">        Args:</span>
<span class="sd">            checkpoint (PathLike | None, optional): The path to the checkpoint file to load the model from.</span>
<span class="sd">            datamodule (EVAL_DATALOADERS | OTXDataModule | None, optional): The data module to use for predictions.</span>
<span class="sd">            return_predictions (bool | None, optional): Whether to return the predictions or not.</span>
<span class="sd">            explain (bool, optional): Whether to dump &quot;saliency_map&quot; and &quot;feature_vector&quot; or not.</span>
<span class="sd">            explain_config (ExplainConfig | None, optional): Explain configuration used for saliency map post-processing</span>
<span class="sd">            **kwargs: Additional keyword arguments for pl.Trainer configuration.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list | None: The predictions if `return_predictions` is True, otherwise None.</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; engine.predict(</span>
<span class="sd">            ...     datamodule=OTXDataModule(),</span>
<span class="sd">            ...     checkpoint=&lt;checkpoint/path&gt;,</span>
<span class="sd">            ...     return_predictions=True,</span>
<span class="sd">            ...     explain=True,</span>
<span class="sd">            ... )</span>

<span class="sd">        CLI Usage:</span>
<span class="sd">            1. To predict a model with work_dir, run</span>
<span class="sd">                ```shell</span>
<span class="sd">                &gt;&gt;&gt; otx predict --work_dir &lt;WORK_DIR_PATH, str&gt;</span>
<span class="sd">                ```</span>
<span class="sd">            2. To predict a specific model, run</span>
<span class="sd">                ```shell</span>
<span class="sd">                &gt;&gt;&gt; otx predict \</span>
<span class="sd">                ...     --work_dir &lt;WORK_DIR_PATH, str&gt; \</span>
<span class="sd">                ...     --checkpoint &lt;CKPT_PATH, str&gt;</span>
<span class="sd">                ```</span>
<span class="sd">            3. To predict with configuration file, run</span>
<span class="sd">                ```shell</span>
<span class="sd">                &gt;&gt;&gt; otx predict \</span>
<span class="sd">                ...     --config &lt;CONFIG_PATH, str&gt; \</span>
<span class="sd">                ...     --checkpoint &lt;CKPT_PATH, str&gt;</span>
<span class="sd">                ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">otx.algo.utils.xai_utils</span> <span class="kn">import</span> <span class="n">process_saliency_maps_in_pred_entity</span><span class="p">,</span> <span class="n">set_crop_padded_map_flag</span>

        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>

        <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">checkpoint</span> <span class="k">if</span> <span class="n">checkpoint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint</span>
        <span class="n">datamodule</span> <span class="o">=</span> <span class="n">datamodule</span> <span class="k">if</span> <span class="n">datamodule</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">datamodule</span>

        <span class="n">is_ir_ckpt</span> <span class="o">=</span> <span class="n">checkpoint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">Path</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">)</span><span class="o">.</span><span class="n">suffix</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;.xml&quot;</span><span class="p">,</span> <span class="s2">&quot;.onnx&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">is_ir_ckpt</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">OVModel</span><span class="p">):</span>
            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auto_configurator</span><span class="o">.</span><span class="n">get_ov_model</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">),</span> <span class="n">label_info</span><span class="o">=</span><span class="n">datamodule</span><span class="o">.</span><span class="n">label_info</span><span class="p">)</span>

        <span class="c1"># NOTE: Re-initiate datamodule for OVModel as model API supports its own data pipeline.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">OVModel</span><span class="p">):</span>
            <span class="n">datamodule</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auto_configurator</span><span class="o">.</span><span class="n">update_ov_subset_pipeline</span><span class="p">(</span><span class="n">datamodule</span><span class="o">=</span><span class="n">datamodule</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">checkpoint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_ir_ckpt</span><span class="p">:</span>
            <span class="n">model_cls</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="vm">__class__</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">model_cls</span><span class="o">.</span><span class="n">load_from_checkpoint</span><span class="p">(</span><span class="n">checkpoint_path</span><span class="o">=</span><span class="n">checkpoint</span><span class="p">,</span> <span class="o">**</span><span class="n">model</span><span class="o">.</span><span class="n">hparams</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">label_info</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">datamodule</span><span class="o">.</span><span class="n">label_info</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;To launch a predict pipeline, the label information should be same &quot;</span>
                <span class="s2">&quot;between the training and testing datasets. &quot;</span>
                <span class="s2">&quot;Please check whether you use the same dataset: &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;model.label_info=</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">label_info</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;datamodule.label_info=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">datamodule</span><span class="o">.</span><span class="n">label_info</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_build_trainer</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">curr_explain_mode</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">explain_mode</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">explain_mode</span> <span class="o">=</span> <span class="n">explain</span>
            <span class="n">predict_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                <span class="n">dataloaders</span><span class="o">=</span><span class="n">datamodule</span><span class="p">,</span>
                <span class="n">return_predictions</span><span class="o">=</span><span class="n">return_predictions</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">explain_mode</span> <span class="o">=</span> <span class="n">curr_explain_mode</span>

        <span class="k">if</span> <span class="n">explain</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">explain_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">explain_config</span> <span class="o">=</span> <span class="n">ExplainConfig</span><span class="p">()</span>
            <span class="n">explain_config</span> <span class="o">=</span> <span class="n">set_crop_padded_map_flag</span><span class="p">(</span><span class="n">explain_config</span><span class="p">,</span> <span class="n">datamodule</span><span class="p">)</span>

            <span class="n">predict_result</span> <span class="o">=</span> <span class="n">process_saliency_maps_in_pred_entity</span><span class="p">(</span><span class="n">predict_result</span><span class="p">,</span> <span class="n">explain_config</span><span class="p">,</span> <span class="n">datamodule</span><span class="o">.</span><span class="n">label_info</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">predict_result</span></div>


<div class="viewcode-block" id="Engine.export">
<a class="viewcode-back" href="../../../guide/reference/_autosummary/otx.engine.html#otx.engine.Engine.export">[docs]</a>
    <span class="k">def</span> <span class="nf">export</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">checkpoint</span><span class="p">:</span> <span class="n">PathLike</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">export_format</span><span class="p">:</span> <span class="n">OTXExportFormatType</span> <span class="o">=</span> <span class="n">OTXExportFormatType</span><span class="o">.</span><span class="n">OPENVINO</span><span class="p">,</span>
        <span class="n">export_precision</span><span class="p">:</span> <span class="n">OTXPrecisionType</span> <span class="o">=</span> <span class="n">OTXPrecisionType</span><span class="o">.</span><span class="n">FP32</span><span class="p">,</span>
        <span class="n">explain</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">export_demo_package</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Export the trained model to OpenVINO Intermediate Representation (IR) or ONNX formats.</span>

<span class="sd">        Args:</span>
<span class="sd">            checkpoint (PathLike | None, optional): Checkpoint to export. Defaults to None.</span>
<span class="sd">            export_config (ExportConfig | None, optional): Config that allows to set export</span>
<span class="sd">            format and precision. Defaults to None.</span>
<span class="sd">            explain (bool): Whether to get &quot;saliency_map&quot; and &quot;feature_vector&quot; or not.</span>
<span class="sd">            export_demo_package (bool): Whether to export demo package with the model.</span>
<span class="sd">                Only OpenVINO model can be exported with demo package.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Path: Path to the exported model.</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; engine.export(</span>
<span class="sd">            ...     checkpoint=&lt;checkpoint/path&gt;,</span>
<span class="sd">            ...     export_format=OTXExportFormatType.OPENVINO,</span>
<span class="sd">            ...     export_precision=OTXExportPrecisionType.FP32,</span>
<span class="sd">            ...     explain=True,</span>
<span class="sd">            ... )</span>

<span class="sd">        CLI Usage:</span>
<span class="sd">            1. To export a model with default setting (OPENVINO, FP32), run</span>
<span class="sd">                ```shell</span>
<span class="sd">                &gt;&gt;&gt; otx export --work_dir &lt;WORK_DIR_PATH, str&gt;</span>
<span class="sd">                ```</span>
<span class="sd">            2. To export a specific checkpoint, run</span>
<span class="sd">                ```shell</span>
<span class="sd">                &gt;&gt;&gt; otx export --config &lt;CONFIG_PATH, str&gt; --checkpoint &lt;CKPT_PATH, str&gt;</span>
<span class="sd">                ```</span>
<span class="sd">            3. To export a model with precision FP16 and format ONNX, run</span>
<span class="sd">                ```shell</span>
<span class="sd">                &gt;&gt;&gt; otx export ... \</span>
<span class="sd">                ...     --export_precision FP16 --export_format ONNX</span>
<span class="sd">                ```</span>
<span class="sd">            4. To export model with &#39;saliency_map&#39; and &#39;feature_vector&#39;, run</span>
<span class="sd">                ```shell</span>
<span class="sd">                &gt;&gt;&gt; otx export ... \</span>
<span class="sd">                ...     --explain True</span>
<span class="sd">                ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">checkpoint</span> <span class="k">if</span> <span class="n">checkpoint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint</span>

        <span class="k">if</span> <span class="n">checkpoint</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;To make export, checkpoint must be specified.&quot;</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">is_ir_ckpt</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">)</span><span class="o">.</span><span class="n">suffix</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;.xml&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">export_demo_package</span> <span class="ow">and</span> <span class="n">export_format</span> <span class="o">==</span> <span class="n">OTXExportFormatType</span><span class="o">.</span><span class="n">ONNX</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;ONNX export is not supported in exportable code mode. &quot;</span>
                <span class="s2">&quot;Exportable code parameter will be disregarded. &quot;</span>
            <span class="p">)</span>
            <span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">export_demo_package</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">is_ir_ckpt</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">export_demo_package</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;IR model is passed as a checkpoint, export automatically switched to exportable code.&quot;</span>
            <span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">export_demo_package</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">is_ir_ckpt</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">OVModel</span><span class="p">):</span>
            <span class="c1"># create OVModel</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auto_configurator</span><span class="o">.</span><span class="n">get_ov_model</span><span class="p">(</span>
                <span class="n">model_name</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">),</span>
                <span class="n">label_info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">datamodule</span><span class="o">.</span><span class="n">label_info</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_ir_ckpt</span><span class="p">:</span>
            <span class="n">model_cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="vm">__class__</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model_cls</span><span class="o">.</span><span class="n">load_from_checkpoint</span><span class="p">(</span>
                <span class="n">checkpoint_path</span><span class="o">=</span><span class="n">checkpoint</span><span class="p">,</span>
                <span class="n">map_location</span><span class="o">=</span><span class="s2">&quot;cpu&quot;</span><span class="p">,</span>
                <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">hparams</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">explain_mode</span> <span class="o">=</span> <span class="n">explain</span>
        <span class="n">exported_model_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">export</span><span class="p">(</span>
            <span class="n">output_dir</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">work_dir</span><span class="p">),</span>
            <span class="n">base_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_EXPORTED_MODEL_BASE_NAME</span><span class="p">,</span>
            <span class="n">export_format</span><span class="o">=</span><span class="n">export_format</span><span class="p">,</span>
            <span class="n">precision</span><span class="o">=</span><span class="n">export_precision</span><span class="p">,</span>
            <span class="n">to_exportable_code</span><span class="o">=</span><span class="n">export_demo_package</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">explain_mode</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">exported_model_path</span></div>


<div class="viewcode-block" id="Engine.optimize">
<a class="viewcode-back" href="../../../guide/reference/_autosummary/otx.engine.html#otx.engine.Engine.optimize">[docs]</a>
    <span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">checkpoint</span><span class="p">:</span> <span class="n">PathLike</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">datamodule</span><span class="p">:</span> <span class="n">TRAIN_DATALOADERS</span> <span class="o">|</span> <span class="n">OTXDataModule</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_data_subset_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">export_demo_package</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Applies NNCF.PTQ to the underlying models (now works only for OV models).</span>

<span class="sd">        PTQ performs int-8 quantization on the input model, so the resulting model</span>
<span class="sd">        comes in mixed precision (some operations, however, remain in FP32).</span>

<span class="sd">        Args:</span>
<span class="sd">            checkpoint (str | Path | None, optional): Checkpoint to optimize. Defaults to None.</span>
<span class="sd">            datamodule (TRAIN_DATALOADERS | OTXDataModule | None, optional): The data module to use for optimization.</span>
<span class="sd">            max_data_subset_size (int | None): The maximum size of the train subset from `datamodule` that would be</span>
<span class="sd">            used for model optimization. If not set, NNCF.PTQ will select subset size according to it&#39;s</span>
<span class="sd">            default settings.</span>
<span class="sd">            export_demo_package (bool): Whether to export demo package with optimized models.</span>
<span class="sd">            It outputs zip archive with stand-alone demo package.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Path: path to the optimized model.</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; engine.optimize(</span>
<span class="sd">            ...     checkpoint=&lt;checkpoint/path&gt;,</span>
<span class="sd">            ...     datamodule=OTXDataModule(),</span>
<span class="sd">            ...     checkpoint=&lt;checkpoint/path&gt;,</span>
<span class="sd">            ... )</span>

<span class="sd">        CLI Usage:</span>
<span class="sd">            1. To optimize a model with IR Model, run</span>
<span class="sd">                ```shell</span>
<span class="sd">                &gt;&gt;&gt; otx optimize \</span>
<span class="sd">                ...     --work_dir &lt;WORK_DIR_PATH, str&gt; \</span>
<span class="sd">                ...     --checkpoint &lt;IR_MODEL_WEIGHT_PATH, str&gt;</span>
<span class="sd">                ```</span>
<span class="sd">            2. To optimize a specific OVModel class with XML, run</span>
<span class="sd">                ```shell</span>
<span class="sd">                &gt;&gt;&gt; otx optimize \</span>
<span class="sd">                ...     --data_root &lt;DATASET_PATH, str&gt; \</span>
<span class="sd">                ...     --checkpoint &lt;IR_MODEL_WEIGHT_PATH, str&gt; \</span>
<span class="sd">                ...     --model &lt;CONFIG | CLASS_PATH_OR_NAME, OVModel&gt; \</span>
<span class="sd">                ...     --model.model_name=&lt;PATH_TO_IR_XML, str&gt;</span>
<span class="sd">                ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">checkpoint</span> <span class="k">if</span> <span class="n">checkpoint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint</span>
        <span class="n">optimize_datamodule</span> <span class="o">=</span> <span class="n">datamodule</span> <span class="k">if</span> <span class="n">datamodule</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">datamodule</span>

        <span class="n">is_ir_ckpt</span> <span class="o">=</span> <span class="n">checkpoint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">Path</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">)</span><span class="o">.</span><span class="n">suffix</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;.xml&quot;</span><span class="p">,</span> <span class="s2">&quot;.onnx&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_ir_ckpt</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Engine.optimize() supports only OV IR or ONNX checkpoints&quot;</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">OVModel</span><span class="p">):</span>
            <span class="n">optimize_datamodule</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auto_configurator</span><span class="o">.</span><span class="n">update_ov_subset_pipeline</span><span class="p">(</span>
                <span class="n">datamodule</span><span class="o">=</span><span class="n">optimize_datamodule</span><span class="p">,</span>
                <span class="n">subset</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auto_configurator</span><span class="o">.</span><span class="n">get_ov_model</span><span class="p">(</span>
                <span class="n">model_name</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">),</span>
                <span class="n">label_info</span><span class="o">=</span><span class="n">optimize_datamodule</span><span class="o">.</span><span class="n">label_info</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">ptq_config</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">max_data_subset_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ptq_config</span><span class="p">[</span><span class="s2">&quot;subset_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_data_subset_size</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">export_demo_package</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span>
                <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">work_dir</span><span class="p">),</span>
                <span class="n">optimize_datamodule</span><span class="p">,</span>
                <span class="n">ptq_config</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmp_dir</span><span class="p">:</span>
            <span class="n">tmp_model_path</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">),</span> <span class="n">optimize_datamodule</span><span class="p">,</span> <span class="n">ptq_config</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">export</span><span class="p">(</span>
                <span class="n">checkpoint</span><span class="o">=</span><span class="n">tmp_model_path</span><span class="p">,</span>
                <span class="n">export_demo_package</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="Engine.explain">
<a class="viewcode-back" href="../../../guide/reference/_autosummary/otx.engine.html#otx.engine.Engine.explain">[docs]</a>
    <span class="k">def</span> <span class="nf">explain</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">checkpoint</span><span class="p">:</span> <span class="n">PathLike</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">datamodule</span><span class="p">:</span> <span class="n">EVAL_DATALOADERS</span> <span class="o">|</span> <span class="n">OTXDataModule</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">explain_config</span><span class="p">:</span> <span class="n">ExplainConfig</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dump</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Run XAI using the specified model and data (test subset).</span>

<span class="sd">        Args:</span>
<span class="sd">            checkpoint (PathLike | None, optional): The path to the checkpoint file to load the model from.</span>
<span class="sd">            datamodule (EVAL_DATALOADERS | OTXDataModule | None, optional): The data module to use for predictions.</span>
<span class="sd">            explain_config (ExplainConfig | None, optional): Config used to handle saliency maps.</span>
<span class="sd">            dump (bool): Whether to dump &quot;saliency_map&quot; or not.</span>
<span class="sd">            **kwargs: Additional keyword arguments for pl.Trainer configuration.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: Saliency maps.</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; engine.explain(</span>
<span class="sd">            ...     datamodule=OTXDataModule(),</span>
<span class="sd">            ...     checkpoint=&lt;checkpoint/path&gt;,</span>
<span class="sd">            ...     explain_config=ExplainConfig(),</span>
<span class="sd">            ...     dump=True,</span>
<span class="sd">            ... )</span>

<span class="sd">        CLI Usage:</span>
<span class="sd">            1. To run XAI with the torch model in work_dir, run</span>
<span class="sd">                ```shell</span>
<span class="sd">                &gt;&gt;&gt; otx explain \</span>
<span class="sd">                ...     --work_dir &lt;WORK_DIR_PATH, str&gt;</span>
<span class="sd">                ```</span>
<span class="sd">            2. To run XAI using the specified model (torch or IR), run</span>
<span class="sd">                ```shell</span>
<span class="sd">                &gt;&gt;&gt; otx explain \</span>
<span class="sd">                ...     --work_dir &lt;WORK_DIR_PATH, str&gt; \</span>
<span class="sd">                ...     --checkpoint &lt;CKPT_PATH, str&gt;</span>
<span class="sd">                ```</span>
<span class="sd">            3. To run XAI using the configuration, run</span>
<span class="sd">                ```shell</span>
<span class="sd">                &gt;&gt;&gt; otx explain \</span>
<span class="sd">                ...     --config &lt;CONFIG_PATH&gt; --data_root &lt;DATASET_PATH, str&gt; \</span>
<span class="sd">                ...     --checkpoint &lt;CKPT_PATH, str&gt;</span>
<span class="sd">                ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">otx.algo.utils.xai_utils</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">dump_saliency_maps</span><span class="p">,</span>
            <span class="n">process_saliency_maps_in_pred_entity</span><span class="p">,</span>
            <span class="n">set_crop_padded_map_flag</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>

        <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">checkpoint</span> <span class="k">if</span> <span class="n">checkpoint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint</span>
        <span class="n">datamodule</span> <span class="o">=</span> <span class="n">datamodule</span> <span class="k">if</span> <span class="n">datamodule</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">datamodule</span>

        <span class="n">is_ir_ckpt</span> <span class="o">=</span> <span class="n">checkpoint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">Path</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">)</span><span class="o">.</span><span class="n">suffix</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;.xml&quot;</span><span class="p">,</span> <span class="s2">&quot;.onnx&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">is_ir_ckpt</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">OVModel</span><span class="p">):</span>
            <span class="n">datamodule</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auto_configurator</span><span class="o">.</span><span class="n">update_ov_subset_pipeline</span><span class="p">(</span><span class="n">datamodule</span><span class="o">=</span><span class="n">datamodule</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auto_configurator</span><span class="o">.</span><span class="n">get_ov_model</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">),</span> <span class="n">label_info</span><span class="o">=</span><span class="n">datamodule</span><span class="o">.</span><span class="n">label_info</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">checkpoint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_ir_ckpt</span><span class="p">:</span>
            <span class="n">model_cls</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="vm">__class__</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">model_cls</span><span class="o">.</span><span class="n">load_from_checkpoint</span><span class="p">(</span><span class="n">checkpoint_path</span><span class="o">=</span><span class="n">checkpoint</span><span class="p">,</span> <span class="o">**</span><span class="n">model</span><span class="o">.</span><span class="n">hparams</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">label_info</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">datamodule</span><span class="o">.</span><span class="n">label_info</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;To launch a explain pipeline, the label information should be same &quot;</span>
                <span class="s2">&quot;between the training and testing datasets. &quot;</span>
                <span class="s2">&quot;Please check whether you use the same dataset: &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;model.label_info=</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">label_info</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;datamodule.label_info=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">datamodule</span><span class="o">.</span><span class="n">label_info</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">model</span><span class="o">.</span><span class="n">explain_mode</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_build_trainer</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">predict_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">datamodule</span><span class="o">=</span><span class="n">datamodule</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">explain_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">explain_config</span> <span class="o">=</span> <span class="n">ExplainConfig</span><span class="p">()</span>
        <span class="n">explain_config</span> <span class="o">=</span> <span class="n">set_crop_padded_map_flag</span><span class="p">(</span><span class="n">explain_config</span><span class="p">,</span> <span class="n">datamodule</span><span class="p">)</span>

        <span class="n">predict_result</span> <span class="o">=</span> <span class="n">process_saliency_maps_in_pred_entity</span><span class="p">(</span><span class="n">predict_result</span><span class="p">,</span> <span class="n">explain_config</span><span class="p">,</span> <span class="n">datamodule</span><span class="o">.</span><span class="n">label_info</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dump</span><span class="p">:</span>
            <span class="n">dump_saliency_maps</span><span class="p">(</span>
                <span class="n">predict_result</span><span class="p">,</span>
                <span class="n">explain_config</span><span class="p">,</span>
                <span class="n">datamodule</span><span class="p">,</span>
                <span class="n">output_dir</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">work_dir</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">explain_mode</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">predict_result</span></div>


<div class="viewcode-block" id="Engine.benchmark">
<a class="viewcode-back" href="../../../guide/reference/_autosummary/otx.engine.html#otx.engine.Engine.benchmark">[docs]</a>
    <span class="k">def</span> <span class="nf">benchmark</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">checkpoint</span><span class="p">:</span> <span class="n">PathLike</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">n_iters</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">extended_stats</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Executes model micro benchmarking on random data.</span>

<span class="sd">        Benchmark can provide latency, throughput, number of parameters,</span>
<span class="sd">        and theoretical computational complexity with batch size 1.</span>
<span class="sd">        The latter two characteristics are available for torch model recipes only.</span>
<span class="sd">        Before the measurements, a warm-up is done.</span>

<span class="sd">        Args:</span>
<span class="sd">            checkpoint (PathLike | None, optional): Path to checkpoint. Optional for torch models. Defaults to None.</span>
<span class="sd">            batch_size (int, optional): Batch size for benchmarking. Defaults to 1.</span>
<span class="sd">            n_iters (int, optional): Number of iterations to average on. Defaults to 10.</span>
<span class="sd">            extended_stats (bool, optional): Flag that enables printing of per module complexity for torch model.</span>
<span class="sd">            Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict[str, str]: a dict with the benchmark results.</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; engine.benchmark(</span>
<span class="sd">            ...     datamodule=OTXDataModule(),</span>
<span class="sd">            ...     batch_size=1,</span>
<span class="sd">            ...     n_iters=20,</span>
<span class="sd">            ...     extended_stats=True,</span>
<span class="sd">            ... )</span>

<span class="sd">        CLI Usage:</span>
<span class="sd">            To run benchmark using the configuration, launch</span>
<span class="sd">                ```shell</span>
<span class="sd">                &gt;&gt;&gt; otx benchmark \</span>
<span class="sd">                ...     --config &lt;CONFIG_PATH&gt; --data_root &lt;DATASET_PATH, str&gt; \</span>
<span class="sd">                ...     --checkpoint &lt;CKPT_PATH, str&gt;</span>
<span class="sd">                ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">checkpoint</span> <span class="k">if</span> <span class="n">checkpoint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint</span>

        <span class="k">if</span> <span class="n">checkpoint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">is_ir_ckpt</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">)</span><span class="o">.</span><span class="n">suffix</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;.xml&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">is_ir_ckpt</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">OVModel</span><span class="p">):</span>
                <span class="c1"># create OVModel</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auto_configurator</span><span class="o">.</span><span class="n">get_ov_model</span><span class="p">(</span>
                    <span class="n">model_name</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">),</span>
                    <span class="n">label_info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">datamodule</span><span class="o">.</span><span class="n">label_info</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_ir_ckpt</span><span class="p">:</span>
                <span class="n">model_cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="vm">__class__</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model_cls</span><span class="o">.</span><span class="n">load_from_checkpoint</span><span class="p">(</span>
                    <span class="n">checkpoint_path</span><span class="o">=</span><span class="n">checkpoint</span><span class="p">,</span>
                    <span class="n">map_location</span><span class="o">=</span><span class="s2">&quot;cpu&quot;</span><span class="p">,</span>
                    <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">hparams</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">OVModel</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;To run benchmark on OV model, checkpoint must be specified.&quot;</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">dummy_infer</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">OTXModel</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
            <span class="n">input_batch</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_dummy_input</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
            <span class="n">model</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">input_batch</span><span class="p">)</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span>

        <span class="n">warmup_iters</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_iters</span> <span class="o">/</span> <span class="mi">10</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">warmup_iters</span><span class="p">):</span>
            <span class="n">dummy_infer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>

        <span class="n">total_time</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_iters</span><span class="p">):</span>
            <span class="n">total_time</span> <span class="o">+=</span> <span class="n">dummy_infer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
        <span class="n">latency</span> <span class="o">=</span> <span class="n">total_time</span> <span class="o">/</span> <span class="n">n_iters</span>
        <span class="n">fps</span> <span class="o">=</span> <span class="n">batch_size</span> <span class="o">/</span> <span class="n">latency</span>

        <span class="n">final_stats</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;latency&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">latency</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> s&quot;</span><span class="p">,</span> <span class="s2">&quot;throughput&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="p">(</span><span class="n">fps</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> FPS&quot;</span><span class="p">}</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">OVModel</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">torch.utils.flop_counter</span> <span class="kn">import</span> <span class="n">convert_num_with_suffix</span><span class="p">,</span> <span class="n">get_suffix_str</span>

                <span class="n">input_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_dummy_input</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">model_fwd</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">input_batch</span><span class="p">)</span>
                <span class="n">depth</span> <span class="o">=</span> <span class="mi">3</span> <span class="k">if</span> <span class="n">extended_stats</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="n">fwd_flops</span> <span class="o">=</span> <span class="n">measure_flops</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">model_fwd</span><span class="p">,</span> <span class="n">print_stats_depth</span><span class="o">=</span><span class="n">depth</span><span class="p">)</span>
                <span class="n">flops_str</span> <span class="o">=</span> <span class="n">convert_num_with_suffix</span><span class="p">(</span><span class="n">fwd_flops</span><span class="p">,</span> <span class="n">get_suffix_str</span><span class="p">(</span><span class="n">fwd_flops</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">3</span><span class="p">))</span>
                <span class="n">final_stats</span><span class="p">[</span><span class="s2">&quot;complexity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flops_str</span> <span class="o">+</span> <span class="s2">&quot; MACs&quot;</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to complete complexity estimation: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">params_num</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">)</span>
            <span class="n">params_num_str</span> <span class="o">=</span> <span class="n">convert_num_with_suffix</span><span class="p">(</span><span class="n">params_num</span><span class="p">,</span> <span class="n">get_suffix_str</span><span class="p">(</span><span class="n">params_num</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span>
            <span class="n">final_stats</span><span class="p">[</span><span class="s2">&quot;parameters_number&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">params_num_str</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">final_stats</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">:</span><span class="s2">&lt;20</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">work_dir</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;benchmark_report.csv&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">final_stats</span><span class="p">))</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">final_stats</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

        <span class="k">return</span> <span class="n">final_stats</span></div>


<div class="viewcode-block" id="Engine.from_config">
<a class="viewcode-back" href="../../../guide/reference/_autosummary/otx.engine.html#otx.engine.Engine.from_config">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_config</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">config_path</span><span class="p">:</span> <span class="n">PathLike</span><span class="p">,</span>
        <span class="n">data_root</span><span class="p">:</span> <span class="n">PathLike</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">work_dir</span><span class="p">:</span> <span class="n">PathLike</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Engine</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Builds the engine from a configuration file.</span>

<span class="sd">        Args:</span>
<span class="sd">            config_path (PathLike): The configuration file path.</span>
<span class="sd">            data_root (PathLike | None): Root directory for the data.</span>
<span class="sd">                Defaults to None. If data_root is None, use the data_root from the configuration file.</span>
<span class="sd">            work_dir (PathLike | None, optional): Working directory for the engine.</span>
<span class="sd">                Defaults to None. If work_dir is None, use the work_dir from the configuration file.</span>
<span class="sd">            kwargs: Arguments that can override the engine&#39;s arguments.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Engine: An instance of the Engine class.</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; engine = Engine.from_config(</span>
<span class="sd">            ...     config=&quot;config.yaml&quot;,</span>
<span class="sd">            ... )</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">otx.cli.utils.jsonargparse</span> <span class="kn">import</span> <span class="n">get_instantiated_classes</span>

        <span class="c1"># For the Engine argument, prepend &#39;engine.&#39; for CLI parser</span>
        <span class="n">filter_kwargs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;device&quot;</span><span class="p">,</span> <span class="s2">&quot;checkpoint&quot;</span><span class="p">,</span> <span class="s2">&quot;task&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">filter_kwargs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;engine.</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">instantiated_config</span><span class="p">,</span> <span class="n">train_kwargs</span> <span class="o">=</span> <span class="n">get_instantiated_classes</span><span class="p">(</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config_path</span><span class="p">,</span>
            <span class="n">data_root</span><span class="o">=</span><span class="n">data_root</span><span class="p">,</span>
            <span class="n">work_dir</span><span class="o">=</span><span class="n">work_dir</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">engine_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">instantiated_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;engine&quot;</span><span class="p">,</span> <span class="p">{}),</span> <span class="o">**</span><span class="n">train_kwargs</span><span class="p">}</span>

        <span class="c1"># Remove any input that is not currently available in Engine and print a warning message.</span>
        <span class="n">set_valid_args</span> <span class="o">=</span> <span class="n">TrainerArgumentsCache</span><span class="o">.</span><span class="n">get_trainer_constructor_args</span><span class="p">()</span><span class="o">.</span><span class="n">union</span><span class="p">(</span>
            <span class="nb">set</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">Engine</span><span class="o">.</span><span class="fm">__init__</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
        <span class="p">)</span>
        <span class="n">removed_args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">engine_key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">engine_kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">engine_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">set_valid_args</span><span class="p">:</span>
                <span class="n">engine_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">engine_key</span><span class="p">)</span>
                <span class="n">removed_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">engine_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">removed_args</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Warning: </span><span class="si">{</span><span class="n">removed_args</span><span class="si">}</span><span class="s2"> -&gt; not available in Engine constructor. &quot;</span>
                <span class="s2">&quot;It will be ignored. Use what need in the right places.&quot;</span>
            <span class="p">)</span>
            <span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">datamodule</span> <span class="o">:=</span> <span class="n">instantiated_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">))</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Cannot instantiate datamodule from config.&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">datamodule</span><span class="p">,</span> <span class="n">OTXDataModule</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">datamodule</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">model</span> <span class="o">:=</span> <span class="n">instantiated_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">))</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Cannot instantiate model from config.&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">OTXModel</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

        <span class="n">model</span><span class="o">.</span><span class="n">label_info</span> <span class="o">=</span> <span class="n">datamodule</span><span class="o">.</span><span class="n">label_info</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">work_dir</span><span class="o">=</span><span class="n">instantiated_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;work_dir&quot;</span><span class="p">,</span> <span class="n">work_dir</span><span class="p">),</span>
            <span class="n">datamodule</span><span class="o">=</span><span class="n">datamodule</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="o">**</span><span class="n">engine_kwargs</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Engine.from_model_name">
<a class="viewcode-back" href="../../../guide/reference/_autosummary/otx.engine.html#otx.engine.Engine.from_model_name">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_model_name</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">task</span><span class="p">:</span> <span class="n">OTXTaskType</span><span class="p">,</span>
        <span class="n">data_root</span><span class="p">:</span> <span class="n">PathLike</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">work_dir</span><span class="p">:</span> <span class="n">PathLike</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Engine</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Builds the engine from a model name.</span>

<span class="sd">        Args:</span>
<span class="sd">            model_name (str): The model name.</span>
<span class="sd">            task (OTXTaskType): The type of OTX task.</span>
<span class="sd">            data_root (PathLike | None): Root directory for the data.</span>
<span class="sd">                Defaults to None. If data_root is None, use the data_root from the configuration file.</span>
<span class="sd">            work_dir (PathLike | None, optional): Working directory for the engine.</span>
<span class="sd">                Defaults to None. If work_dir is None, use the work_dir from the configuration file.</span>
<span class="sd">            kwargs: Arguments that can override the engine&#39;s arguments.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Engine: An instance of the Engine class.</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; engine = Engine.from_model_name(</span>
<span class="sd">            ...     model_name=&quot;atss_mobilenetv2&quot;,</span>
<span class="sd">            ...     task=&quot;DETECTION&quot;,</span>
<span class="sd">            ...     data_root=&lt;dataset/path&gt;,</span>
<span class="sd">            ... )</span>

<span class="sd">            If you want to override configuration from default config:</span>
<span class="sd">                &gt;&gt;&gt; overriding = {</span>
<span class="sd">                ...     &quot;data.train_subset.batch_size&quot;: 2,</span>
<span class="sd">                ...     &quot;data.test_subset.subset_name&quot;: &quot;TESTING&quot;,</span>
<span class="sd">                ... }</span>
<span class="sd">                &gt;&gt;&gt; engine = Engine(</span>
<span class="sd">                ...     model_name=&quot;atss_mobilenetv2&quot;,</span>
<span class="sd">                ...     task=&quot;DETECTION&quot;,</span>
<span class="sd">                ...     data_root=&lt;dataset/path&gt;,</span>
<span class="sd">                ...     **overriding,</span>
<span class="sd">                ... )</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">default_config</span> <span class="o">=</span> <span class="n">DEFAULT_CONFIG_PER_TASK</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
        <span class="n">model_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">default_config</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="n">model_path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">.yaml&quot;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_path</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">candidate_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">stem</span> <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">)]</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Model config file not found: </span><span class="si">{</span><span class="n">config</span><span class="si">}</span><span class="s2">, please check the model name. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Available models for </span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="s2"> task are </span><span class="si">{</span><span class="n">candidate_list</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_config</span><span class="p">(</span>
            <span class="n">config_path</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
            <span class="n">data_root</span><span class="o">=</span><span class="n">data_root</span><span class="p">,</span>
            <span class="n">work_dir</span><span class="o">=</span><span class="n">work_dir</span><span class="p">,</span>
            <span class="n">task</span><span class="o">=</span><span class="n">task</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span></div>


    <span class="c1"># ------------------------------------------------------------------------ #</span>
    <span class="c1"># Property and setter functions provided by Engine.</span>
    <span class="c1"># ------------------------------------------------------------------------ #</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">work_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PathLike</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Work directory.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_work_dir</span>

    <span class="nd">@work_dir</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">work_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">work_dir</span><span class="p">:</span> <span class="n">PathLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_work_dir</span> <span class="o">=</span> <span class="n">work_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">default_root_dir</span><span class="o">=</span><span class="n">work_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">is_trainer_args_identical</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">device</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DeviceConfig</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Device engine uses.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_device</span>

    <span class="nd">@device</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">device</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">:</span> <span class="n">DeviceType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">is_xpu_available</span><span class="p">()</span> <span class="ow">and</span> <span class="n">device</span> <span class="o">==</span> <span class="n">DeviceType</span><span class="o">.</span><span class="n">auto</span><span class="p">:</span>
            <span class="n">device</span> <span class="o">=</span> <span class="n">DeviceType</span><span class="o">.</span><span class="n">xpu</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_device</span> <span class="o">=</span> <span class="n">DeviceConfig</span><span class="p">(</span><span class="n">accelerator</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">accelerator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_device</span><span class="o">.</span><span class="n">accelerator</span><span class="p">,</span> <span class="n">devices</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_device</span><span class="o">.</span><span class="n">devices</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">is_trainer_args_identical</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">num_devices</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Number of devices for Engine use.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_device</span><span class="o">.</span><span class="n">devices</span>

    <span class="nd">@num_devices</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">num_devices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_devices</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Setter function for multi-gpu.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_device</span><span class="o">.</span><span class="n">devices</span> <span class="o">=</span> <span class="n">num_devices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">devices</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_device</span><span class="o">.</span><span class="n">devices</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">is_trainer_args_identical</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">trainer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Trainer</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the trainer object associated with the engine.</span>

<span class="sd">        To get this property, you should execute `Engine.train()` function first.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Trainer: The trainer object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trainer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Please run train() first&quot;</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trainer</span>

    <span class="k">def</span> <span class="nf">_build_trainer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Instantiate the trainer based on the model parameters.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">requires_update</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trainer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="c1"># set up xpu device</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_device</span><span class="o">.</span><span class="n">accelerator</span> <span class="o">==</span> <span class="n">DeviceType</span><span class="o">.</span><span class="n">xpu</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;xpu_single&quot;</span><span class="p">)</span>
                <span class="c1"># add plugin for Automatic Mixed Precision on XPU</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;precision&quot;</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span> <span class="o">==</span> <span class="mi">16</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">plugins</span><span class="o">=</span><span class="p">[</span><span class="n">MixedPrecisionXPUPlugin</span><span class="p">()])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="s2">&quot;precision&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">args</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">is_trainer_args_identical</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_trainer</span><span class="o">.</span><span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">work_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trainer</span><span class="o">.</span><span class="n">default_root_dir</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">trainer_params</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the parameters used for training the model.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A dictionary containing the training parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">args</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OTXModel</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the model object associated with the engine.</span>

<span class="sd">        Returns:</span>
<span class="sd">            OTXModel: The OTXModel object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span>

    <span class="nd">@model</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">OTXModel</span> <span class="o">|</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets the model for the engine.</span>

<span class="sd">        Args:</span>
<span class="sd">            model (OTXModel | str): The model to be set.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auto_configurator</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">label_info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">datamodule</span><span class="o">.</span><span class="n">label_info</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="o">=</span> <span class="n">model</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">datamodule</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OTXDataModule</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the datamodule object associated with the engine.</span>

<span class="sd">        Returns:</span>
<span class="sd">            OTXDataModule: The OTXDataModule object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datamodule</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Please include the `data_root` or `datamodule` when creating the Engine.&quot;</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datamodule</span></div>

</pre></div>

            </article>
            
            
            
            <footer class="bd-footer-article">
                <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
            </footer>
            
          </div>
          
          
          
            <div class="bd-sidebar-secondary bd-toc">
              
<div class="toc-item">
  
<div id="searchbox"></div>
</div>

<div class="toc-item">
  
</div>

<div class="toc-item">
  
</div>

            </div>
          
          
        </div>
        <footer class="bd-footer-content">
          <div class="bd-footer-content__inner">
            
          </div>
        </footer>
        
      </main>
    </div>
  </div>

  
    
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=796348d33e8b1d947c94"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=796348d33e8b1d947c94"></script>

  <footer class="bd-footer"><div class="bd-footer__inner container">
  
  <div class="footer-item">
    
<p class="copyright">

    &copy; Copyright 2024, OpenVINOâ„¢ Training Extensions Contributors.<br>

</p>

  </div>
  
  <div class="footer-item">
    <p class="theme-version">
    Built with the
    <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">
        PyData Sphinx Theme
    </a>
    0.12.0.
</p>
  </div>
  
  <div class="footer-item">
    
<p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 7.2.6.<br>
</p>

  </div>
  
</div>
  </footer>
  </body>
</html>