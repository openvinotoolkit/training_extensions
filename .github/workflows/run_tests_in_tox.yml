on:
  workflow_call:
    inputs:
      python-version:
        required: true
        type: string
        default: "3.10"
      toxenv-pyver:
        description: "[py38, py39, py310]"
        required: true
        type: string
        default: "py310"
      toxenv-task:
        description: "[all, act, ano, cls, det, seg, iseg]"
        required: true
        type: string
        default: "all"
      tests-dir:
        required: true
        type: string
        default: "tests/integration"
      timeout-minutes:
        type: number
        default: 720
      upload-artifact:
        type: boolean
        default: false

jobs:
  run_tests_in_tox:
    runs-on: [self-hosted, linux, x64, debug]
    timeout-minutes: ${{ inputs.timeout_minutes }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ inputs.python_version }}
      - name: Install dependencies
        run: python -m pip install -r requirements/dev.txt
      - name: E2E Tests
        run: tox -e tests-${{ inputs.toxenv_task }}-${{ inputs.toxenv_pyver }} -- ${{ inputs.tests_dir }}
      - name: Upload test results
        uses: actions/upload-artifact@v3
        with:
          name: test-results-${{ inputs.toxenv_task }}-${{ inputs.toxenv_pyver }}
          path: .tox/test-results-${{ inputs.toxenv_task }}-${{ inputs.toxenv_pyver }}.xml
        # Use always() to always run this step to publish test results when there are test failures
        if: ${{ inputs.upload_artifact && always() }}
